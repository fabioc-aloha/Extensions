name: Publish to VS Code Marketplace

on:
    workflow_dispatch:
        inputs:
            extension:
                description: 'Extension to publish (or "all" to publish all)'
                required: true
                type: choice
                options:
                    - all
                    - hook-studio
                    - workspace-watchdog
                    - mcp-app-starter
                    - secret-guard
                    - focus-timer
                    - knowledge-decay-tracker
                    - markdown-to-word
                    - brandfetch-logo-fetcher
                    - ai-voice-reader
                    - dev-wellbeing
                    - pptx-builder
                    - replicate-image-studio
                    - mermaid-diagram-pro
                    - svg-toolkit
                    - gamma-slide-assistant
            pre_release:
                description: "Publish as pre-release?"
                required: false
                type: boolean
                default: false

jobs:
    pre-publish-check:
        name: Pre-publish Safety Check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Verify no secrets in package
              run: |
                  # Check no .env files or hardcoded keys
                  if grep -r "REPLICATE_API_KEY\|BRANDFETCH_API_KEY\|sk-" --include="*.ts" --include="*.js" extensions/ shared/ ; then
                    echo "âŒ Hardcoded credentials detected! Aborting publish."
                    exit 1
                  fi
                  echo "âœ… No hardcoded credentials found."

            - name: Verify VSCE_PAT secret exists
              run: |
                  if [ -z "${{ secrets.VSCE_PAT }}" ]; then
                    echo "âŒ VSCE_PAT secret not set. Go to Settings > Secrets to add it."
                    exit 1
                  fi
                  echo "âœ… VSCE_PAT is configured."

    publish:
        name: Publish ${{ github.event.inputs.extension }}
        needs: pre-publish-check
        runs-on: ubuntu-latest
        environment: marketplace
        strategy:
            fail-fast: false
            max-parallel: 3

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install shared dependencies
              run: npm install
              working-directory: shared

            - name: Publish extension(s)
              env:
                  VSCE_PAT: ${{ secrets.VSCE_PAT }}
              run: |
                  EXTENSION="${{ github.event.inputs.extension }}"
                  PRE_RELEASE="${{ github.event.inputs.pre_release }}"
                  VSCE_FLAGS="--no-dependencies"
                  if [ "$PRE_RELEASE" = "true" ]; then VSCE_FLAGS="$VSCE_FLAGS --pre-release"; fi

                  if [ "$EXTENSION" = "all" ]; then
                    EXTENSIONS=$(ls extensions/)
                  else
                    EXTENSIONS="$EXTENSION"
                  fi

                  for ext in $EXTENSIONS; do
                    echo "ðŸ“¤ Publishing $ext..."
                    cd extensions/$ext
                    npm install
                    npm run compile
                    npx @vscode/vsce publish $VSCE_FLAGS -p "$VSCE_PAT"
                    echo "âœ… Published $ext"
                    cd -
                  done
